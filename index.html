<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nightcord</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <!-- Name Chooser Overlay -->
  <div id="name-chooser" class="name-chooser hidden">
    <div class="name-chooser-content">
      <div class="logo-area">
        <svg width="60" height="60" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M13,10.69v2.72H10.23V10.69Zm3,0v2.69h2.69V10.72ZM23.29,12A11.31,11.31,0,1,1,12,.67,11.31,11.31,0,0,1,23.29,12Zm-.18.07a8.87,8.87,0,1,0-8.87,8.86A8.87,8.87,0,0,0,23.11,12.05Z" fill="#ffffff" fill-opacity="0.9"></path>
        </svg>
      </div>
      <h2 id="chooser-title">Nightcord</h2>
      <p id="chooser-subtitle" class="subtitle">ËØ∑ËæìÂÖ•‰Ω†ÁöÑÊòµÁß∞‰ª•Âä†ÂÖ•</p>
      
      <div class="input-wrapper">
        <input type="text" id="name-input" class="name-input" placeholder="ÊòµÁß∞" maxlength="32" autocomplete="off">
        <div class="input-focus-border"></div>
        <div id="name-error" class="input-error"></div>
      </div>
      
      <button id="name-submit" class="name-submit">
        <span id="chooser-submit-text">ËøõÂÖ• Nightcord</span>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </button>
      
      <button id="chooser-close" class="chooser-close hidden" title="ÂÖ≥Èó≠">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>
  <div class="chat-root">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="server-header">
        <span>Nightcord</span>
        <span style="font-size:16px;">&#9660;</span>
      </div>
      <div class="sidebar-content">
        <div class="channel">
          <div class="channel-icon"><svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path
                d="M13,10.69v2.72H10.23V10.69Zm3,0v2.69h2.69V10.72ZM23.29,12A11.31,11.31,0,1,1,12,.67,11.31,11.31,0,0,1,23.29,12Zm-.18.07a8.87,8.87,0,1,0-8.87,8.86A8.87,8.87,0,0,0,23.11,12.05Z"
                fill="white"></path>
            </svg></div>
          <span>ËÅäÂ§©</span>
        </div>
        <div class="section-label">&gt; ËÅäÂ§©</div>
        <div id="voice-users"></div>
        <div class="section-label">&gt; Á¶ªÁ∫ø</div>
      </div>
    </div>
    <!-- Main Chat Area -->
    <div class="main">
      <div class="chat-header">
        <div class="channel-icon"><svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M13,10.69v2.72H10.23V10.69Zm3,0v2.69h2.69V10.72ZM23.29,12A11.31,11.31,0,1,1,12,.67,11.31,11.31,0,0,1,23.29,12Zm-.18.07a8.87,8.87,0,1,0-8.87,8.86A8.87,8.87,0,0,0,23.11,12.05Z"
              fill="white"></path>
          </svg></div>
        <span style="font-weight:600;">ËÅäÂ§©</span>
        <div class="window-buttons">
          <span class="window-btn blue"></span>
          <span class="window-btn yellow"></span>
          <span class="window-btn red"></span>
        </div>
      </div>
      <div class="messages" id="messages"></div>
      <div class="input-area">
        <div class="input-box">
          <div id="mention-list" class="mention-list hidden"></div>
          <input type="text" class="input" id="messageInput" placeholder="ÂèëÈÄÅÊ∂àÊÅØ">
          <div class="input-btns">
            <button class="input-btn" title="@"><span>@</span></button>
            <button class="input-btn" title="ÊñáÊú¨"><span style="font-weight:bold;">Aa</span></button>
            <button class="input-btn" title="Ë°®ÊÉÖ"><span>üòä</span></button>
            <button class="input-btn" title="ÈôÑ‰ª∂"><span>üìé</span></button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- <script>
const users = [
  { name: "K", status: "online", avatar: "K", color: "bg-pink-500" },
  { name: "Èõ™", status: "online", avatar: "Èõ™", color: "bg-purple-400" },
  { name: "„Åà„Å™„Å™„Çì", status: "online", avatar: "„Åà", color: "bg-teal-400" },
  { name: "Amia", status: "online", avatar: "A", color: "bg-pink-400" },
];
const messages = [
  { user: "K", avatar: "K", color: "bg-purple-600", time: "Êò®Êó• 15:51", text: "„ÇÇ„ÅÜÂ∞ë„Åó„Åß„Ç¢„ÉÉ„Éó„Åß„Åç„Åù„ÅÜ" },
  { user: "Amia", avatar: "A", color: "bg-pink-400", time: "Êò®Êó• 15:54", text: "„Åä„Äú„ÄÅÊ•Ω„Åó„Åø‚ô™" },
  { user: "Amia", avatar: "A", color: "bg-pink-400", time: "Êò®Êó• 16:13", text: "„ÅÇ„Çä„Åå„Å®ÔºÅ" },
  { user: "Èõ™", avatar: "Èõ™", color: "bg-purple-400", time: "Êò®Êó• 16:15", text: "ËÅ¥„ÅÑ„Å®„Åè„Å≠" },
  { user: "„Åà„Å™„Å™„Çì", avatar: "„Åà", color: "bg-teal-400", time: "Êò®Êó• 20:36", text: "„Åò„ÇÉ„ÄÅ‰∏ÄÊó¶ËêΩ„Å°„Çã" },
  { user: "K", avatar: "K", color: "bg-purple-600", time: "Êò®Êó• 20:38", text: "„ÅÜ„Çì„ÄÅ„Åæ„Åü25ÊôÇ„Å´" },
  { user: "„Åà„Å™„Å™„Çì", avatar: "„Åà", color: "bg-teal-400", time: "Êò®Êó• 20:39", text: "„ÅØ„Éº„ÅÑ" },
  { user: "Amia", avatar: "A", color: "bg-pink-400", time: "Êò®Êó• 23:45", text: "Ë™∞„Åå„ÅÑ„Çã„ÄúÔºü" },
  { user: "K", avatar: "K", color: "bg-purple-600", time: "Êò®Êó• 23:46", text: "„ÅÑ„Çã„Çà" },
];
function renderVoiceUsers() {
  const container = document.getElementById('voice-users');
  container.innerHTML = '';
  users.forEach(user => {
    const div = document.createElement('div');
    div.className = 'voice-user';
    div.innerHTML = `
      <div class="voice-user-info">
        <span class="avatar ${user.color}">${user.avatar}</span>
        <span style="font-size:14px;">${user.name}</span>
      </div>
    `;
    container.appendChild(div);
  });
}
function renderMessages() {
  const container = document.getElementById('messages');
  container.innerHTML = '';
  messages.forEach(msg => {
    const msgDiv = document.createElement('div');
    msgDiv.className = 'message';
    msgDiv.innerHTML = `
      <span class="avatar ${msg.color}">${msg.avatar}</span>
      <div class="message-content">
        <div class="message-header">
          <span class="message-user">${msg.user}</span>
          <span class="message-time">${msg.time}</span>
        </div>
        ${msg.text ? `<p class="message-text">${msg.text}</p>` : ''}
        ${msg.file ? `
          <div class="message-file">
            <span class="file-icon">üéµ</span>
            <div class="file-info">
              <div class="file-name">${msg.file.name}</div>
              <div class="file-size">${msg.file.size}</div>
            </div>
            <button class="file-download" title="‰∏ãËΩΩ">‚¨áÔ∏è</button>
          </div>
        ` : ''}
      </div>
    `;
    container.appendChild(msgDiv);
  });
  container.scrollTop = container.scrollHeight;
}
document.addEventListener('DOMContentLoaded', () => {
  renderVoiceUsers();
  renderMessages();
  const input = document.getElementById('messageInput');
  input.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && this.value.trim()) {
      messages.push({
        user: 'K',
        avatar: 'K',
        color: 'bg-purple-600',
        time: '‰ªä',
        text: this.value.trim()
      });
      this.value = '';
      renderMessages();
    }
  });
});
</script> -->
  <script src="event-bus.js"></script>
  <script src="websocket-mgr.js"></script>
  <script src="nightcord-mgr.js"></script>
  <script src="storage-manager.js"></script>
  <script src="ui-sticker-service.js"></script>
  <script src="ui-autocomplete.js"></script>
  <script src="ui-manager.js"></script>
  <script src="voice-room-manager-simple.js"></script>
  <script src="voice-ui-manager.js"></script>
  <script src="nightcord.js"></script>
  <script>
    let nightcord = new Nightcord();
    const params = new URLSearchParams(location.search);
    if (params.has('test')) {
      nightcord.init('nightcord-test');
    } else {
      nightcord.init();
    }
  </script>
  <script src="pangu.js"></script>

  <!-- Video Container -->
  <div id="video-container" class="video-container"></div>

  <script>
    // Audio playback helper - create audio elements for remote users
    window.audioElements = new Map();

    window.playAudio = function(stream, username) {
      console.log(`[Audio] Setting up audio for ${username}`);

      // Remove old audio element if exists
      if (window.audioElements.has(username)) {
        const oldAudio = window.audioElements.get(username);
        oldAudio.srcObject = null;
        oldAudio.remove();
        window.audioElements.delete(username);
      }

      // Create new audio element
      const audio = document.createElement('audio');
      audio.autoplay = true;
      audio.controls = true; // Add controls for debugging
      audio.volume = 1.0;
      audio.muted = false;
      audio.id = `audio-${username}`;

      // Add to video container so it's visible
      const container = document.getElementById('video-container');
      const audioBox = document.createElement('div');
      audioBox.className = 'video-box';
      audioBox.style.height = 'auto';
      audioBox.style.padding = '10px';
      audioBox.innerHTML = `<div class="video-label">${username} (Audio)</div>`;
      audioBox.appendChild(audio);
      container.appendChild(audioBox);

      // Set stream
      audio.srcObject = stream;
      window.audioElements.set(username, audio);

      console.log(`[Audio] Audio element created for ${username}`, {
        srcObject: audio.srcObject,
        tracks: stream.getTracks().map(t => ({
          kind: t.kind,
          enabled: t.enabled,
          muted: t.muted,
          readyState: t.readyState
        }))
      });

      // Monitor events
      audio.onloadedmetadata = () => {
        console.log(`[Audio] Metadata loaded for ${username}`);
        audio.play().catch(err => {
          console.error(`[Audio] Play failed for ${username}:`, err);
        });
      };

      audio.onplay = () => {
        console.log(`[Audio] Play event for ${username}`);
      };

      audio.onplaying = () => {
        console.log(`[Audio] Playing event for ${username}`, {
          readyState: audio.readyState,
          paused: audio.paused,
          volume: audio.volume,
          currentTime: audio.currentTime
        });
      };

      audio.onerror = (e) => {
        console.error(`[Audio] Error for ${username}:`, e);
      };

      audio.onvolumechange = () => {
        console.log(`[Audio] Volume changed for ${username}:`, audio.volume, 'muted:', audio.muted);
      };

      // Force play immediately
      const playPromise = audio.play();
      if (playPromise !== undefined) {
        playPromise.then(() => {
          console.log(`[Audio] Initial play successful for ${username}`);
        }).catch(err => {
          console.error(`[Audio] Initial play failed for ${username}:`, err);
        });
      }

      return audio;
    };

    window.removeAudio = function(username) {
      if (window.audioElements.has(username)) {
        const audio = window.audioElements.get(username);
        audio.srcObject = null;
        audio.parentElement?.remove();
        window.audioElements.delete(username);
        console.log(`[Audio] Removed audio for ${username}`);
      }
    };
  </script>
</body>

</html>
